%!TeX root=../Monografia - Mikhael Pinto.tex
%("dica" para o editor de texto: este arquivo é parte de um documento maior)

\chapter{O painel administrativo}
\label{cap:implementacao}

Este capítulo descreve a implementação do painel administrativo desenvolvido para apoiar o piloto BikeSP. A Seção~\ref{sec:arquitetura} apresenta a arquitetura de software do sistema completo, mostrando como o painel se integra aos demais componentes. A Seção~\ref{sec:processo-desenvolvimento} descreve o processo de desenvolvimento adotado pela equipe. A Seção~\ref{sec:abas-painel} detalha cada uma das funcionalidades implementadas nas diferentes abas do painel, incluindo inserção de usuários, gerenciamento de coortes, bônus, remuneração, contestações, viagens, notificações e localizações.

\section{Arquitetura de software}
\label{sec:arquitetura}
O sistema BikeSP é composto por múltiplos componentes distribuídos em diferentes
infraestruturas, conforme ilustrado na Figura~\ref{fig:arquitetura}. O
\textbf{Painel Administrativo} atua como componente central de orquestração,
integrando-se aos demais módulos do sistema.

Os usuários realizavam inscrição através do \textbf{Formulário LimeSurvey}, hospedado em uma máquina virtual NuvemUSP. Após
o período de inscrições, um administrador utiliza o painel para executar um
\emph{script} que extraía os dados dos candidatos do LimeSurvey e os inseria no
banco de dados PostgreSQL do BikeSP, já filtrando os candidatos selecionados pela 
equipe de pesquisa pelos critérios de elegibilidade e balanceamento experimental definidos.

A máquina virtual Amazon hospeda o
\textbf{Banco de Dados PostgreSQL} e o \textbf{Back-end Flask}, que implementa a
lógica de negócio do sistema (validação de viagens, cálculo de créditos,
gerenciamento de usuários e coortes). O painel comunica-se com o back-end via
APIs REST para consultar e manipular dados.

O \textbf{App Android} é utilizado pelos participantes
para registrar viagens de bicicleta. As viagens são enviadas ao back-end, que as
valida e processa. O painel permite que administradores visualizem, auditem e, se
necessário, corrijam dados de viagens (por exemplo, erros de geolocalização).

O sistema integra-se com: (i) \textbf{Google
Firebase} para autenticação e notificações push; (ii) \textbf{APIs de
Geolocalização} (TomTom e Nominatim) para validação e correção de coordenadas
GPS; e (iii) \textbf{Loja Virtual SPTrans} para processamento de pagamentos dos
créditos acumulados pelos participantes.

O painel é acessado pela \textbf{equipe de suporte} e
operação, permitindo gestão de cadastros, atribuição de coortes, criação de
bônus, aprovação de contestações e geração de relatórios para a equipe de
economistas.

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.95\textwidth]{diagrama_arquitetura_bikesp.png}
  \caption{Diagrama simplificado dos componentes do sistema BikeSP.}
  \label{fig:arquitetura}
\end{figure}

\section{Processo de desenvolvimento}
\label{sec:processo-desenvolvimento}
O desenvolvimento envolveu múltiplos stakeholders e ciclos curtos de validação:
economistas (Tainá Souza Pacheco e Ciro Biderman), suporte e atendimento (Sávio 
Campos de Souza), coordenação e orientação (Fabio Kon e Paulo Meirelles), além 
da equipe de desenvolvimento (Kaiky Cintra e Mikhael Pinto). As demandas foram priorizadas e 
acompanhadas via registro de \textit{issues}, criação de \textit{pull requests} 
e revisão colaborativa, organizada no Gitlab, com homologação contínua durante
o pré-teste, o período de inscrições, a preparação de julho e a execução do
piloto.

\section{Arquitetura do backend}
\label{sec:arquitetura-backend}
O backend do sistema BikeSP foi desenvolvido utilizando o framework Flask (versão 
3.0.0), um framework web para Python que oferece flexibilidade 
na organização de código e escalabilidade para aplicações de médio a grande porte. 
A escolha do Flask se justifica por sua natureza modular, extensa documentação, 
comunidade ativa e capacidade de integração com bibliotecas especializadas.

O backend implementado consiste em \textbf{171 arquivos Python}, totalizando 
\textbf{21.325 linhas de código}, organizados em uma arquitetura de camadas bem 
definida. O sistema conta com \textbf{848 funções} implementadas, distribuídas 
em módulos especializados que seguem o princípio de separação de responsabilidades. 
A aplicação expõe \textbf{69 rotas HTTP} através de \textbf{22 módulos de 
endpoints} distintos, servindo tanto o aplicativo móvel quanto o painel 
administrativo web através de \textbf{42 templates HTML} renderizados no servidor.

A estrutura arquitetural segue uma \textbf{arquitetura em camadas} (layered 
architecture) com clara separação de responsabilidades entre apresentação, lógica 
de negócio e acesso a dados. O sistema combina duas abordagens arquiteturais 
complementares: (i) API RESTful para comunicação com o aplicativo móvel, onde 
endpoints retornam dados em formato JSON; e (ii) MTV (Model-Template-View) para 
o painel administrativo web, onde templates Jinja2 são renderizados no servidor. 

As três camadas principais são:

\begin{itemize}
  \item \textbf{Camada de Apresentação}: Composta por 22 módulos de endpoints 
  que recebem requisições HTTP e 42 templates HTML para o painel administrativo. 
  Inclui decoradores de validação que interceptam e validam requisições antes 
  do processamento.
  
  \item \textbf{Camada de Lógica de Negócio}: Contém gerenciadores que orquestram 
  operações complexas, processadores de domínio específicos (viagem, contestação, 
  remuneração), classes de domínio com métodos de validação (Viagem, Local, 
  Trajeto) e validadores de CPF, email e coordenadas.
  
  \item \textbf{Camada de Acesso a Dados}: Implementada através de 115 funções 
  especializadas: 75 funções de consulta, 23 funções de inserção, 
  8 funções de atualização e 9 funções de remoção, todas 
  utilizando queries SQL parametrizadas com proteção contra SQL injection.
\end{itemize}

Esta organização modular permite que cada componente seja desenvolvido, testado 
e mantido de forma independente, facilitando tanto a escalabilidade horizontal 
quanto a manutenibilidade do código ao longo do ciclo de vida do projeto.

A aplicação Flask é inicializada através de um padrão factory
que configura todas as extensões, registra blueprints, define middlewares de 
segurança e estabelece conexões com serviços externos como Firebase para 
autenticação e notificações push. Esta abordagem permite a criação de múltiplas 
instâncias da aplicação com configurações distintas para desenvolvimento, testes 
e produção.

O sistema implementa múltiplas camadas de segurança através de JWT (JSON Web 
Tokens) para autenticação stateless, hash de senhas e rate limiting 
por IP e por usuário.

A integração com serviços externos é realizada através de módulos especializados 
que se conectam com: Firebase Admin SDK (autenticação e notificações push via 
FCM), APIs de geocodificação (TomTom, Google Maps e Nominatim) com fallback em 
cascata, e SMTP via Gmail para envio de emails transacionais.

O painel administrativo utiliza templates Jinja2 com renderização no servidor e 
interatividade client-side através de HTMX (Hypermedia-Driven Applications). 
Os 42 templates estão organizados em 9 páginas principais (Bônus, Contestações, 
Coortes, Inserção de Usuários, Localizações, Notificações, Remuneração, Usuários 
e Viagens) e mais de 30 componentes reutilizáveis como tabelas dinâmicas, 
formulários e modais. A visualização de mapas de trajetos e localizações é 
implementada usando a biblioteca Leaflet.js com tiles OpenStreetMap.

\section{Abas do painel e uso no piloto}
\label{sec:abas-painel}

A Figura~\ref{fig:painel-geral} apresenta uma visão geral do painel administrativo, 
mostrando o menu de navegação com todas as funcionalidades disponíveis e a interface 
da página de viagens. O sistema organiza as funcionalidades em 9 páginas principais 
acessíveis através do menu lateral esquerdo.

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.95\textwidth]{figuras/bikesp_full.png}
  \caption{Visão geral do painel administrativo BikeSP mostrando o menu de navegação e a página de viagens.}
  \label{fig:painel-geral}
\end{figure}

\subsection{Inserção de usuários}
\input{conteudo/02-insercao-usuarios}

\subsection{Usuários}
\input{conteudo/02-usuarios}


\subsection{Coortes}
\label{sec:coortes}
\input{conteudo/02-coortes}


\subsection{Bônus}
\label{sec:bonus}
\input{conteudo/02-bonus}


\subsection{Remuneração}
\label{sec:remuneracao}
\input{conteudo/02-remuneracao}


\subsection{Contestações}
\label{sec:contestacoes}
\input{conteudo/02-contestacoes}


\subsection{Viagens}
\label{sec:viagens}
\input{conteudo/02-viagens}

\subsection{Notificações}
\label{sec:notificacoes}
\input{conteudo/02-notificacoes}

\subsection{Localizações}
\label{sec:localizacoes}
\input{conteudo/02-localizacoes}

Após a descrição detalhada da implementação do painel administrativo e suas funcionalidades, o próximo capítulo apresenta os resultados alcançados durante a execução do piloto, incluindo dados quantitativos de uso e uma avaliação do impacto do sistema nas operações.

